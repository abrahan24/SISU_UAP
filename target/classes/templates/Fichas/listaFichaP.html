<!doctype html>
<html lang="en">



<head th:insert="~{layout/head :: head}"></head>


<body data-topbar="colored">

    <div id="layout-wrapper">

        <div th:insert="~{layout/topbar :: topbar}"></div>
        <div class="vertical-menu">
            <div th:insert="~{layout/sidebar :: sidebar}"></div>
        </div>
        <div class="main-content">
            <div class="page-content">

                <!-- Page-Title -->
                <div class="page-title-box">
                    <div class="container-fluid">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="page-title mb-1">Lista Asegurados</h4>
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Asegurados</a></li>
                                    <li class="breadcrumb-item active">Datos de Personas</li>
                                </ol>
                            </div>
                            <div class="col-md-4">
                                <div class="float-right d-none d-md-block">
                                    <div class="dropdown">
                                        <button class="btn btn-light btn-rounded dropdown-toggle" type="button"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <i class="mdi mdi-settings-outline mr-1"></i> Settings
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-right dropdown-menu-animated">
                                            <a class="dropdown-item" href="#">Action</a>
                                            <a class="dropdown-item" href="#">Another action</a>
                                            <a class="dropdown-item" href="#">Something else here</a>
                                            <div class="dropdown-divider"></div>
                                            <a class="dropdown-item" href="#">Separated link</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="page-content-wrapper">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="header-title">Asegurados</h4><br>



                                        <table id="datatable-buttons"
                                            class="table table-striped table-bordered dt-responsive nowrap botonesH"
                                            style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th>Nombre:</th>
                                                    <th>Apellidos:</th>
                                                    <th>ci:</th>
                                                    <th>Expedido</th>
                                                    <th>Codigo Asegurado:</th>
                                                    <th>Genero:</th>
                                                    <th>Num. Celular:</th>

                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="f : ${fichas}" th:if="${f.ficha.estado == 'AA'}">
                                                    <!-- <td th:text="${f.asegurado.persona.nombres}"></td> -->
                                                    <td th:if="${f.ficha.asegurado != null and f.ficha.asegurado.persona != null}"
                                                        th:text="${f.ficha.asegurado.persona.nombres}"></td>
                                                    <!-- <td th:text="${f.asegurado.persona.apPaterno + '  ' + f.asegurado.persona.apMaterno}"></td> -->
                                                    <td th:if="${f.ficha.asegurado != null and f.ficha.asegurado.persona != null}"
                                                        th:text="${f.ficha.asegurado.persona.apPaterno + '  ' + f.ficha.asegurado.persona.apMaterno}">
                                                    </td>
                                                    <!-- <td th:text="${f.asegurado.persona.ci}"></td> -->
                                                    <td th:if="${f.ficha.asegurado != null and f.ficha.asegurado.persona != null}"
                                                        th:text="${f.ficha.asegurado.persona.ci}"></td>
                                                    <!-- <td th:text="${f.asegurado.persona.dip.codDip}"></td>
                                                <td th:text="${f.asegurado.codigoAsegurado}"></td>
                                                <td th:text="${f.asegurado.persona.sexo}"></td> -->
                                                    <td th:if="${f.ficha.asegurado != null and f.ficha.asegurado.persona != null and f.ficha.asegurado.persona.dip != null}"
                                                        th:text="${f.ficha.asegurado.persona.dip.codDip}"></td>
                                                    <td th:if="${f.ficha.asegurado != null}"
                                                        th:text="${f.ficha.asegurado.codigoAsegurado}"></td>
                                                    <td th:if="${f.ficha.asegurado != null and f.ficha.asegurado.persona != null}"
                                                        th:text="${f.ficha.asegurado.persona.sexo}"></td>
                                                    <td th:if="${f.ficha.asegurado != null and f.ficha.asegurado.persona != null}"
                                                        th:text="${f.ficha.asegurado.persona.celular}"></td>

                                                    <!-- <td th:if="${f.asegurado.persona.tipos_estado_civil != null}" th:text="${f.asegurado.persona.tipos_estado_civil.NomEstadoCivil}"></td>
                                                <td th:if="${f.asegurado.persona.grado_academico != null}" th:text="${f.asegurado.persona.grado_academico.nombre_gradoAcademico}"></td> -->



                                                    <!-- <td>
                                                    <input type="hidden" th:hidden="${f.idFicha}">
                                                    <form th:action="@{'../../../../vistaHistorialSeguro'}" method="POST">
                                                        <input type="hidden" th:name="idFicha" th:value="${f.asegurado.idAsegurado}">
                                                        <button class="btn btn-primary sombre" type="submit">Historial</button>
                                                    </form>
                                                </td> -->
                                                    <td>
                                                        <input type="hidden"
                                                            th:hidden="${f != null and f.ficha.asegurado != null}" />
                                                        <div class="btn-group" role="group">
                                                            <a type="button"
                                                                th:href="@{'../../../../vistaHistorialSeguro/'+${f.ficha.asegurado.idAsegurado}+'/'+${f.ficha.idFicha}}"
                                                                class="btn btn-outline-secondary btn-sm"
                                                                data-toggle="tooltip" data-placement="top"
                                                                title="Historia Clinica">
                                                                <i class="mdi mdi-folder-plus-outline"></i>
                                                            </a>
                                                            <!-- <a type="button" th:href="@{'../../../../verModeloIndicacionMedica/'+${f.ficha.asegurado.idAsegurado}}" class="btn btn-outline-secondary btn-sm" data-toggle="tooltip" data-placement="top" title="Indicaciones Medicas" target="_blank">
                                                            <i class="mdi mdi-folder-plus-outline"></i>
                                                        </a> -->

                                                            <a type="button"
                                                                th:href="@{'../../../../verModeloOrdenQuirurgico/'+${f.ficha.asegurado.idAsegurado}+'/'+${f.ficha.idFicha}}"
                                                                class="btn btn-outline-secondary btn-sm"
                                                                data-toggle="tooltip" data-placement="top"
                                                                title="Orden Quirurgica" target="_blank">
                                                                <i class="mdi mdi-folder-plus-outline"></i>
                                                            </a>
                                                            <div class="btn-group" role="group">
                                                                <button id="btnGroupDrop1" type="button"
                                                                    class="btn btn-outline-secondary btn-sm"
                                                                    data-toggle="dropdown" aria-haspopup="true"
                                                                    aria-expanded="false">
                                                                    indicaciones<i
                                                                        class="mdi mdi-chevron-down ml-1"></i>
                                                                </button>
                                                                <div class="dropdown-menu"
                                                                    aria-labelledby="btnGroupDrop1">
                                                                    <a class="dropdown-item"
                                                                        th:href="@{'../../../../verModeloIndicacionMedicaObservacion/'+${f.ficha.asegurado.idAsegurado}}"
                                                                        target="_blank">Observación</a>
                                                                    <a class="dropdown-item"
                                                                        th:href="@{'../../../../verModeloIndicacionMedicaInternacion/'+${f.ficha.asegurado.idAsegurado}}"
                                                                        target="_blank">Internación</a>
                                                                </div>
                                                            </div>
                                                            <div class="btn-group" role="group">
                                                                <button id="btnGroupDrop1" type="button"
                                                                    class="btn btn-outline-secondary btn-sm"
                                                                    data-toggle="dropdown" aria-haspopup="true"
                                                                    aria-expanded="false">
                                                                    recetarios<i class="mdi mdi-chevron-down ml-1"></i>
                                                                </button>
                                                                <div class="dropdown-menu"
                                                                    aria-labelledby="btnGroupDrop1">
                                                                    <a type="button" th:onclick="abriModal([[${f.ficha.asegurado.idAsegurado}]], [[${f.ficha.asegurado.persona.nombres}]], [[${f.ficha.asegurado.persona.apPaterno}]]
                                                                    ,[[${f.ficha.asegurado.persona.apMaterno}]],[[${f.ficha.asegurado.codigoAsegurado}]], [[${f.ficha.asegurado.persona.sexo}]],
                                                                    [[${f.ficha.asegurado.persona.ci}]],[[${fecha}]], [[${f.ficha.asegurado.persona.fecha_nac}]]
                                                                    )" class="dropdown-item">Recibo/recetario</a>

                                                                    <a class="dropdown-item">Solicitud examenes de
                                                                        laboratorio</a>
                                                                    <a class="dropdown-item">Recibo/recetario
                                                                        quirofano</a>

                                                                </div>
                                                            </div>
                                                            <a th:attr="onclick='completarFicha(\'' + ${f.ficha.idFicha} + '\' , \'' + ${f.ficha.asegurado.persona.nombres} + '\', \'' + ${idUsuario} + '\')'"
                                                                type="button" class="btn btn-outline-success btn-sm"
                                                                data-toggle="tooltip" data-placement="top"
                                                                title="Completar">
                                                                <i class="mdi mdi-check-bold"></i>
                                                            </a>
                                                            <a th:attr="onclick='rechazarFicha(\'' + ${f.ficha.idFicha} + '\' , \'' + ${f.ficha.asegurado.persona.nombres} + '\', \'' + ${idUsuario} + '\')'"
                                                                type="button" class="btn btn-outline-danger btn-sm"
                                                                data-toggle="tooltip" data-placement="top"
                                                                title="Rechazar">
                                                                <i class="mdi mdi-trash-can"></i>
                                                            </a>


                                                        </div>

                                                        <!--<form th:action="@{'../../../../vistaHistorialSeguro'}" method="POST">
                                                        <input type="hidden" th:if="${f != null and f.asegurado != null}" th:name="idFicha" th:value="${f.asegurado.idAsegurado}" />
                                                        <button class="btn btn-primary sombre" type="submit">Historial</button>
                                                    </form>-->
                                                    </td>

                                                </tr>
                                            </tbody>
                                        </table>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade bd-example-modal-lg" tabindex="-1" id="modal1" role="dialog"
                aria-labelledby="myLargeModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>DATOS DEL RECETARIO</h3>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <form id="form1" th:action="@{/generarReceta}" method="POST">
                                                <input type="hidden" name="id_asegurado" id="id_asegurado">


                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <label for="nombreAdministrativo">Nombre Completo</label>
                                                        <input type="text" class="form-control" name="nombre" readonly>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label for="nombreAdministrativo">Edad</label>
                                                        <input type="text" class="form-control" name="edad" readonly>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label for="nombreAdministrativo">Código</label>
                                                        <input type="text" class="form-control" name="codigo" readonly>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label for="nombreAdministrativo">Sexo</label>
                                                        <input type="text" class="form-control" name="sexo" readonly>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label for="nombreAdministrativo">Fecha</label>
                                                        <input type="text" class="form-control" name="fecha" readonly>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label for="nombreAdministrativo">C.I.</label>
                                                        <input type="text" class="form-control" name="ci" readonly>
                                                    </div>

                                                </div>
                                                <hr>
                                                
                                                <div class="form-group row">
                                                    <h5 class="modal-title ">Indicaciones:</h5>
                                                    <div class="col-md-10 mb-3">
                                                        <div>
                                                            <textarea required class="form-control" rows="3" name="indicacion"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                                <hr>
                                                <h5 class="modal-title mt-0">Medicamentos Recetados:</h5>

                                                <div class="form-group row">

                                                    <!-- <div class="col-md-8">
                                                        <select class="js-example-basic-multiple" multiple="multiple"  style="width: 100%;">
                                                            <option th:each="l : ${linames}" th:if="${l.estadoLiname != 'X' }" th:text="${l.medicamento}"
                                                                th:value="${l.idLiname}"></option>
                                                        </select>
                                                    </div> -->

                                                    <div class="">
                                                        <br>
                                                        <button type="button" class="btn btn-primary btn-sm"
                                                            onclick="agregarInput()">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                        <span>Agregar Medicamentos</span>
                                                    </div>
                                                    <!-- <div class="col-md-6" >
                                                        <label for="cantidad">Medicamento</label>
                                                        <select class="js-example-basic" style="width: 100%;" name="medicamentos">
                                                            <option value="">Seleccionar...</option>
                                                            <option th:each="l : ${linames}" th:if="${l.estadoLiname != 'X' }" th:text="${l.medicamento}"
                                                                th:value="${l.idLiname}"></option>
                                                        </select>
                                                    </div>

                                                    <div class="col-md-4">
                                                        <label for="cantidad">Cantidad Recetada</label>
                                                        <input type="text" class="form-control" name="cantidad"  >
                                                    </div> -->
                                                </div>
                                                <div id="contenedorInputs" class="mt-3">
                                                </div>

                                                <div class="form-group mt-4 text-center">
                                                    <button class="btn btn-primary waves-effect waves-light"
                                                        type="submit">Generar</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <div th:insert="~{layout/footer :: footer}"></div>
    </div>
    </div>
    <div th:insert="~{layout/right-sidebar :: right-sidebar}"></div>
    <div class="rightbar-overlay"></div>



    <script type="text/javascript" th:inline="javascript">
        var contadorInputs = 0;
        function agregarInput() {
            contadorInputs++;

            var contenidoHTML = `
                <div class="form-group row justify-content-center">
                    <div class="">
                        <button class="btn btn-danger btn-sm" onclick="eliminarInput(this)">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                    <div class="col-md-6">
                        <select id="miSelect_${contadorInputs}" class="js-example-basic" style="width: 100%;" name="medicamentos" required>
                            <option></option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input id="miInputTexto_${contadorInputs}" class="form-control" type="text" name="cantidad" placeholder="cantidad recetada" required>
                    </div>
                </div>
            `;

            var nuevoFormGroup = document.createElement("div");
            nuevoFormGroup.innerHTML = contenidoHTML;

            var contenedor = document.getElementById("contenedorInputs");
            contenedor.appendChild(nuevoFormGroup);

            var nuevoSelect = document.getElementById(`miSelect_${contadorInputs}`);

            $.ajax({
                url: '/linames',
                method: 'GET',
                success: function (response) {
                    $(nuevoSelect).empty();
                    response.forEach(liname => {
                        var option = $('<option></option>').attr('value', liname.idLiname).text(liname.medicamento);
                        $(nuevoSelect).append(option);
                    });
                },
                error: function () {
                    console.error('Error al obtener los linames');
                }
            });
            $('.js-example-basic').select2({
                placeholder: "Seleccione..."
            });
        }

        function eliminarInput(element) {
            var formGroup = element.closest('.form-group');
            formGroup.remove();
        }
    </script>

    <script th:inline="javascript">

        function abriModal(idAsegurado, nombres, apPaterno, apMaterno, codigoAsegurado, sexo, ci, fecha, fechaN) {
            // Mostrar el modal
            $('#modal1').modal('show');

            // Configurar select2
            $('.js-example-basic').select2({
                placeholder: "Seleccione..."
            });

            // Asignar valores a los inputs del modal
            $('input[name="nombre"]').val(nombres + ' ' + apPaterno + ' ' + apMaterno);
            $('input[name="codigo"]').val(codigoAsegurado);
            $('input[name="sexo"]').val(sexo);
            $('input[name="ci"]').val(ci);
            $('input[name="fecha"]').val(fecha);
            $('input[name="id_asegurado"]').val(idAsegurado);

            // Calcular la edad
            var birthDate = new Date(fechaN);
            var actualDate = new Date(fecha);
            var age = actualDate.getFullYear() - birthDate.getFullYear();
            var month = actualDate.getMonth() - birthDate.getMonth();
            if (month < 0 || (month === 0 && actualDate.getDate() < birthDate.getDate())) {
                age--;
            }

            $('input[name="edad"]').val(age);

            $('#form1').submit(function(event) {
            event.preventDefault();
            var form = document.getElementById("form1"); 
            var action = form.action;
            var formData = $(this).serialize();

            $.ajax({
                type: 'POST',
                url: $(this).attr('action'),
                data: formData,
                contentType: 'application/x-www-form-urlencoded',
                success: function(response) {
                    var mensaje = response;
                    if(mensaje == "1"){
                        Swal.fire({
                            title: 'Asignación Realizada con Éxito!',
                            icon: "success",
                            showConfirmButton: false,
                            timer: 1500
                        });
                        setTimeout(function () {
                            location.href = "../../../../fichasAsegurado/"+mensaje;
                        }, 1500);
                    }
                      
                   
                },
                error: function(xhr, status, error) {
                    toastr.error('Ha ocurrido un error. Por favor, intenta nuevamente. ' + xhr, status, error);
                    console.error(error);
                }
            });
        });
        }


        function rechazarFicha(id, nombre, idusuario) {
            Swal.fire({
                title: "Atencion!",
                text: "¿Esta seguro que desea rechazar la ficha del paciente: " + nombre + "?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "SI, Rechazar",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    // Si el usuario hace clic en "Sí, eliminar"
                    $.ajax({
                        type: 'POST',
                        url: "/rechazar-ficha/" + id,
                        success: function (response) {
                            Swal.fire(
                                'Rechazado!',
                                'La Ficha fue rechaza con éxito.',
                                'success'
                            ).then((result) => {
                                // Redirigir a otro método después de eliminar
                                window.location.href = "/fichasAsegurado/" + idusuario;
                            });
                        },
                        error: function (xhr, status, error) {
                            console.log(error);
                        }
                    });
                }
            });
        }

        function completarFicha(id, nombre, idusuario) {
            Swal.fire({
                title: "Atencion!",
                text: "¿Esta seguro que desea completar la atención del paciente: " + nombre + "?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "SI, Aceptar",
                cancelButtonText: "Cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    // Si el usuario hace clic en "Sí, eliminar"
                    $.ajax({
                        type: 'POST',
                        url: "/completar-ficha/" + id,
                        success: function (response) {
                            Swal.fire(
                                'Completado!',
                                'La Atención fue completada con éxito.',
                                'success'
                            ).then((result) => {
                                // Redirigir a otro método después de eliminar
                                window.location.href = "/fichasAsegurado/" + idusuario;
                            });
                        },
                        error: function (xhr, status, error) {
                            console.log(error);
                        }
                    });
                }
            });
        }

    </script>




    <div th:insert="~{layout/scripts :: scripts}"></div>
</body>

</html>